{% extends "base.html" %}

{% block title %}Admin Panel - Messages - {{ site_name }}{% endblock %}

{% block content %}
<section class="py-5" style="margin-top: 80px;">
    <div class="container">
        <h1 class="mb-4">Admin Panel</h1>
        <p class="lead mb-5">View all submissions from contact forms, course enrollments, and internship applications.</p>
        
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab">Contact Messages ({{ messages|length }})</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="enrollments-tab" data-bs-toggle="tab" data-bs-target="#enrollments" type="button" role="tab">Course Enrollments ({{ enrollments|length }})</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="applications-tab" data-bs-toggle="tab" data-bs-target="#applications" type="button" role="tab">Internship Applications ({{ applications|length }})</button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Contact Messages Tab -->
            <div class="tab-pane fade show active" id="contact" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        {% if messages %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Subject</th>
                                            <th>Message Preview</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for message in messages|reverse %}
                                        <tr>
                                            <td><small>{{ message.created_at.strftime('%Y-%m-%d') }}</small></td>
                                            <td>{{ message.name }}</td>
                                            <td><a href="mailto:{{ message.email }}">{{ message.email }}</a></td>
                                            <td>{{ message.phone }}</td>
                                            <td>{{ message.subject }}</td>
                                            <td><small class="text-muted">{{ message.message[:50] }}...</small></td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#messageModal{{ message.id }}" title="View full message">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage({{ message.id }}, '{{ message.email }}')" title="Delete message">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>

                                        <!-- Message Detail Modal -->
                                        <div class="modal fade" id="messageModal{{ message.id }}" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Message from {{ message.name }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p><strong>Name:</strong> {{ message.name }}</p>
                                                        <p><strong>Email:</strong> <a href="mailto:{{ message.email }}">{{ message.email }}</a></p>
                                                        <p><strong>Phone:</strong> {{ message.phone }}</p>
                                                        <p><strong>Subject:</strong> {{ message.subject }}</p>
                                                        <p><strong>Date:</strong> {{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                                                        <hr>
                                                        <p><strong>Message:</strong></p>
                                                        <p class="border p-3 bg-light">{{ message.message }}</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <a href="mailto:{{ message.email }}" class="btn btn-primary">Reply via Email</a>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-center text-muted py-4">No contact messages yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Course Enrollments Tab -->
            <div class="tab-pane fade" id="enrollments" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        {% if enrollments %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Course</th>
                                            <th>Method</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for enrollment in enrollments|reverse %}
                                        <tr>
                                            <td><small>{{ enrollment.enrolled_at.strftime('%Y-%m-%d') }}</small></td>
                                            <td>{{ enrollment.name }}</td>
                                            <td><a href="mailto:{{ enrollment.email }}">{{ enrollment.email }}</a></td>
                                            <td>{{ enrollment.phone }}</td>
                                            <td>{{ enrollment.course_name }}</td>
                                            <td><span class="badge bg-secondary text-uppercase">{{ enrollment.payment_method or 'razorpay' }}</span></td>
                                            <td>
                                                {% if enrollment.status == 'completed' %}
                                                    <span class="badge bg-success">completed</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">pending</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if enrollment.status != 'completed' %}
                                                    <button class="btn btn-sm btn-outline-success" onclick="verifyEnrollment({{ enrollment.id }})" title="Verify and send email">
                                                        <i class="fas fa-check"></i> Verify
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-sm btn-outline-secondary" disabled title="Already verified">
                                                        <i class="fas fa-check-circle"></i> Verified
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteEnrollment({{ enrollment.id }}, '{{ enrollment.course_name }}')" title="Delete enrollment">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-center text-muted py-4">No course enrollments yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Internship Applications Tab -->
            <div class="tab-pane fade" id="applications" role="tabpanel">
                <div class="card shadow-sm">
                    <div class="card-body">
                        {% if applications %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Position</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for application in applications|reverse %}
                                        <tr>
                                            <td><small>{{ application.applied_at.strftime('%Y-%m-%d') }}</small></td>
                                            <td>{{ application.name }}</td>
                                            <td><a href="mailto:{{ application.email }}">{{ application.email }}</a></td>
                                            <td>{{ application.phone }}</td>
                                            <td>{{ application.internship_role }}</td>
                                            <td>
                                                {% if application.status == 'accepted' %}
                                                    <span class="badge bg-success">{{ application.status }}</span>
                                                {% elif application.status == 'rejected' %}
                                                    <span class="badge bg-danger">{{ application.status }}</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">{{ application.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#applicationModal{{ application.id }}" title="View full application">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="updateApplicationStatus({{ application.id }})" title="Change status">
                                                    <i class="fas fa-edit"></i> Status
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication({{ application.id }}, '{{ application.name }}')" title="Delete application">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>

                                        <!-- Application Detail Modal -->
                                        <div class="modal fade" id="applicationModal{{ application.id }}" tabindex="-1">
                                            <div class="modal-dialog modal-lg">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Application from {{ application.name }}</h5>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <p><strong>Name:</strong> {{ application.name }}</p>
                                                        <p><strong>Email:</strong> <a href="mailto:{{ application.email }}">{{ application.email }}</a></p>
                                                        <p><strong>Phone:</strong> {{ application.phone }}</p>
                                                        <p><strong>Position:</strong> {{ application.internship_role }}</p>
                                                        <p><strong>Date Applied:</strong> {{ application.applied_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                                                        <p><strong>Current Status:</strong> 
                                                            {% if application.status == 'accepted' %}
                                                                <span class="badge bg-success">{{ application.status }}</span>
                                                            {% elif application.status == 'rejected' %}
                                                                <span class="badge bg-danger">{{ application.status }}</span>
                                                            {% else %}
                                                                <span class="badge bg-warning text-dark">{{ application.status }}</span>
                                                            {% endif %}
                                                        </p>
                                                        <hr>
                                                        <p><strong>Cover Letter:</strong></p>
                                                        <p class="border p-3 bg-light">{{ application.cover_letter }}</p>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <a href="mailto:{{ application.email }}" class="btn btn-primary">Send Email</a>
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-center text-muted py-4">No internship applications yet.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4" role="alert">
            <strong>âœ“ Admin Panel Features:</strong> View, manage, verify enrollments, and delete messages or applications. Click "View" to see full content details.
        </div>
    </div>
</section>

<!-- Status Update Modal for Applications -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Application Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select new status:</p>
                <div class="btn-group d-grid gap-2" role="group">
                    <input type="radio" class="btn-check" name="status" id="pending" value="pending" checked>
                    <label class="btn btn-outline-warning" for="pending">Pending</label>

                    <input type="radio" class="btn-check" name="status" id="accepted" value="accepted">
                    <label class="btn btn-outline-success" for="accepted">Accepted</label>

                    <input type="radio" class="btn-check" name="status" id="rejected" value="rejected">
                    <label class="btn btn-outline-danger" for="rejected">Rejected</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentApplicationId = null;

// Delete message
function deleteMessage(id, email) {
    if (confirm(`Are you sure you want to delete the message from ${email}?`)) {
        fetch(`/admin/message/${id}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                if (d.status === 'success') {
                    location.reload();
                }
            })
            .catch(e => alert('Error: ' + e));
    }
}

// Delete enrollment
function deleteEnrollment(id, course) {
    if (confirm(`Are you sure you want to delete the enrollment for ${course}?`)) {
        fetch(`/admin/enrollment/${id}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                if (d.status === 'success') {
                    location.reload();
                }
            })
            .catch(e => alert('Error: ' + e));
    }
}

// Delete application
function deleteApplication(id, name) {
    if (confirm(`Are you sure you want to delete the application from ${name}?`)) {
        fetch(`/admin/application/${id}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                if (d.status === 'success') {
                    location.reload();
                }
            })
            .catch(e => alert('Error: ' + e));
    }
}

// Verify enrollment
function verifyEnrollment(id) {
    if (confirm('Verify this enrollment and send confirmation email?')) {
        fetch(`/admin/verify-enrollment/${id}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                if (d.status === 'success') {
                    location.reload();
                }
            })
            .catch(e => alert('Error: ' + e));
    }
}

// Update application status
function updateApplicationStatus(id) {
    currentApplicationId = id;
    const modal = new bootstrap.Modal(document.getElementById('statusModal'), {});
    modal.show();
}

// Confirm status update
function confirmStatusUpdate() {
    const status = document.querySelector('input[name="status"]:checked').value;
    fetch(`/admin/application/${currentApplicationId}/update-status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status })
    })
        .then(r => r.json())
        .then(d => {
            alert(d.message);
            if (d.status === 'success') {
                location.reload();
            }
        })
        .catch(e => alert('Error: ' + e));
    
    bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
}
</script>
{% endblock %}
